<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°—Ç—Ä—ñ–º—ñ–Ω–≥–æ–≤–∏–π —Å–∞–π—Ç</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 100%;
            text-align: center;
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
            font-size: 2em;
        }

        p {
            color: #666;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 16px;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            font-weight: 600;
            margin: 10px;
        }

        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .button:active {
            transform: translateY(0);
        }

        .button.stop {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            font-weight: 500;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        .hidden {
            display: none;
        }

        .stream-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .stream-link {
            background: white;
            padding: 10px;
            border-radius: 5px;
            word-break: break-all;
            margin: 10px 0;
            font-family: monospace;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="icon">üì∫</div>
        <h1>–°—Ç—Ä—ñ–º—ñ–Ω–≥–æ–≤–∏–π —Å–∞–π—Ç</h1>
        <p>–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É –Ω–∏–∂—á–µ, —â–æ–± –Ω–∞–¥–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ –µ–∫—Ä–∞–Ω—É —Ç–∞ –ø–æ—á–∞—Ç–∏ —Ç—Ä–∞–Ω—Å–ª—è—Ü—ñ—é</p>
        
        <button class="button" id="startBtn" onclick="startStreaming()">
            üé¨ –ü–æ—á–∞—Ç–∏ —Ç—Ä–∞–Ω—Å–ª—è—Ü—ñ—é
        </button>
        
        <button class="button stop hidden" id="stopBtn" onclick="stopStreaming()">
            ‚èπÔ∏è –ó—É–ø–∏–Ω–∏—Ç–∏ —Ç—Ä–∞–Ω—Å–ª—è—Ü—ñ—é
        </button>
        
        <div id="status"></div>
        
        <div id="streamInfo" class="stream-info hidden">
            <h3>–¢—Ä–∞–Ω—Å–ª—è—Ü—ñ—è –∞–∫—Ç–∏–≤–Ω–∞!</h3>
            <p>–ü–æ—Å–∏–ª–∞–Ω–Ω—è –¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É:</p>
            <div class="stream-link" id="streamLink"></div>
            <button class="button" onclick="openStreamPage()">
                üîó –í—ñ–¥–∫—Ä–∏—Ç–∏ —Å—Ç–æ—Ä—ñ–Ω–∫—É —Ç—Ä–∞–Ω—Å–ª—è—Ü—ñ—ó
            </button>
        </div>
    </div>

    <script>
        let mediaStream = null;
        let streamWindow = null;
        let streamId = null;

        async function startStreaming() {
            try {
                showStatus('–ó–∞–ø–∏—Ç –¥–æ—Å—Ç—É–ø—É –¥–æ –µ–∫—Ä–∞–Ω—É...', 'info');
                
                // –ó–∞–ø–∏—Ç –¥–æ—Å—Ç—É–ø—É –¥–æ –µ–∫—Ä–∞–Ω—É
                mediaStream = await navigator.mediaDevices.getDisplayMedia({
                    video: {
                        cursor: "always"
                    },
                    audio: false
                });

                // –ì–µ–Ω–µ—Ä—É—î–º–æ —É–Ω—ñ–∫–∞–ª—å–Ω–∏–π ID –¥–ª—è —Å—Ç—Ä—ñ–º—É
                streamId = 'stream_' + Date.now();
                
                // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Å—Ç—Ä—ñ–º –≤ sessionStorage –¥–ª—è –ø–µ—Ä–µ–¥–∞—á—ñ –≤ —ñ–Ω—à–µ –≤—ñ–∫–Ω–æ
                sessionStorage.setItem('activeStream', streamId);
                
                showStatus('–¢—Ä–∞–Ω—Å–ª—è—Ü—ñ—è —Ä–æ–∑–ø–æ—á–∞—Ç–∞!', 'success');
                document.getElementById('startBtn').classList.add('hidden');
                document.getElementById('stopBtn').classList.remove('hidden');
                document.getElementById('streamInfo').classList.remove('hidden');
                
                const streamUrl = window.location.origin + window.location.pathname + '?view=' + streamId;
                document.getElementById('streamLink').textContent = streamUrl;

                // –í—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ –Ω–æ–≤–µ –≤—ñ–∫–Ω–æ –¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É
                openStreamPage();

                // –û–±—Ä–æ–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è —Å—Ç—Ä—ñ–º—É
                mediaStream.getVideoTracks()[0].onended = () => {
                    stopStreaming();
                };

            } catch (error) {
                console.error('–ü–æ–º–∏–ª–∫–∞:', error);
                if (error.name === 'NotAllowedError') {
                    showStatus('–î–æ—Å—Ç—É–ø –¥–æ –µ–∫—Ä–∞–Ω—É –≤—ñ–¥—Ö–∏–ª–µ–Ω–æ', 'error');
                } else {
                    showStatus('–ü–æ–º–∏–ª–∫–∞: ' + error.message, 'error');
                }
            }
        }

        function openStreamPage() {
            if (streamId) {
                const streamUrl = window.location.origin + window.location.pathname + '?view=' + streamId;
                streamWindow = window.open(streamUrl, '_blank', 'width=1280,height=720');
            }
        }

        function stopStreaming() {
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }
            
            sessionStorage.removeItem('activeStream');
            streamId = null;

            if (streamWindow && !streamWindow.closed) {
                streamWindow.close();
            }

            showStatus('–¢—Ä–∞–Ω—Å–ª—è—Ü—ñ—è –∑—É–ø–∏–Ω–µ–Ω–∞', 'info');
            document.getElementById('startBtn').classList.remove('hidden');
            document.getElementById('stopBtn').classList.add('hidden');
            document.getElementById('streamInfo').classList.add('hidden');
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = 'status ' + type;
        }

        // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞, —á–∏ —Ü–µ —Å—Ç–æ—Ä—ñ–Ω–∫–∞ –ø–µ—Ä–µ–≥–ª—è–¥—É
        const urlParams = new URLSearchParams(window.location.search);
        const viewStreamId = urlParams.get('view');

        if (viewStreamId) {
            // –¶–µ —Å—Ç–æ—Ä—ñ–Ω–∫–∞ –ø–µ—Ä–µ–≥–ª—è–¥—É
            document.body.innerHTML = `
                <style>
                    body {
                        margin: 0;
                        padding: 0;
                        background: #000;
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        height: 100vh;
                        flex-direction: column;
                    }
                    video {
                        max-width: 100%;
                        max-height: 90vh;
                        border-radius: 10px;
                        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
                    }
                    .viewer-info {
                        color: white;
                        margin-top: 20px;
                        text-align: center;
                    }
                    .error-message {
                        color: #ff6b6b;
                        padding: 20px;
                        text-align: center;
                        font-size: 18px;
                    }
                </style>
                <video id="streamVideo" autoplay playsinline></video>
                <div class="viewer-info">
                    <p>üî¥ –¢—Ä–∞–Ω—Å–ª—è—Ü—ñ—è –≤ –ø—Ä—è–º–æ–º—É –µ—Ñ—ñ—Ä—ñ</p>
                    <p id="viewerStatus">–û—á—ñ–∫—É–≤–∞–Ω–Ω—è —Å—Ç—Ä—ñ–º—É...</p>
                </div>
            `;

            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å—Ç—Ä—ñ–º—É
            const checkInterval = setInterval(() => {
                const activeStreamId = sessionStorage.getItem('activeStream');
                if (activeStreamId === viewStreamId) {
                    // –°—Ç—Ä—ñ–º –∞–∫—Ç–∏–≤–Ω–∏–π - –Ω–∞–º–∞–≥–∞—î–º–æ—Å—å –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–æ—Å—Ç—É–ø
                    document.getElementById('viewerStatus').textContent = '–ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ —Ç—Ä–∞–Ω—Å–ª—è—Ü—ñ—ó...';
                    
                    // –í—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ –±–∞—Ç—å–∫—ñ–≤—Å—å–∫–µ –≤—ñ–∫–Ω–æ –¥–ª—è –¥–æ—Å—Ç—É–ø—É –¥–æ mediaStream
                    if (window.opener && window.opener.mediaStream) {
                        const video = document.getElementById('streamVideo');
                        video.srcObject = window.opener.mediaStream;
                        document.getElementById('viewerStatus').textContent = '–¢—Ä–∞–Ω—Å–ª—è—Ü—ñ—è –∞–∫—Ç–∏–≤–Ω–∞';
                        clearInterval(checkInterval);
                    }
                } else {
                    document.getElementById('viewerStatus').innerHTML = 
                        '<span class="error-message">‚ö†Ô∏è –¢—Ä–∞–Ω—Å–ª—è—Ü—ñ—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –∞–±–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞</span>';
                }
            }, 500);

            // –û—á–∏—â—É—î–º–æ —ñ–Ω—Ç–µ—Ä–≤–∞–ª —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥ —è–∫—â–æ —Å—Ç—Ä—ñ–º –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ
            setTimeout(() => {
                clearInterval(checkInterval);
            }, 10000);
        }

        // –û—á–∏—â–µ–Ω–Ω—è –ø—Ä–∏ –∑–∞–∫—Ä–∏—Ç—Ç—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
        window.addEventListener('beforeunload', () => {
            if (mediaStream) {
                stopStreaming();
            }
        });
    </script>
</body>
</html>
