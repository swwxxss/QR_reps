<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°—Ç—Ä—ñ–º—ñ–Ω–≥–æ–≤–∏–π —Å–∞–π—Ç</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 100%;
            text-align: center;
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
            font-size: 2em;
        }

        p {
            color: #666;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 16px;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            font-weight: 600;
            margin: 10px;
        }

        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .button.stop {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            font-weight: 500;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .hidden {
            display: none;
        }

        .stream-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        /* –°—Ç–∏–ª—ñ –¥–ª—è —Å—Ç–æ—Ä—ñ–Ω–∫–∏ –ø–µ—Ä–µ–≥–ª—è–¥—É */
        .viewer-page {
            margin: 0;
            padding: 0;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            flex-direction: column;
        }

        video {
            max-width: 95%;
            max-height: 90vh;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .viewer-info {
            color: white;
            margin-top: 20px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container" id="mainContainer">
        <div style="font-size: 4em; margin-bottom: 20px;">üì∫</div>
        <h1>–°—Ç—Ä—ñ–º—ñ–Ω–≥–æ–≤–∏–π —Å–∞–π—Ç</h1>
        <p>–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É –Ω–∏–∂—á–µ, —â–æ–± –Ω–∞–¥–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ –µ–∫—Ä–∞–Ω—É —Ç–∞ –ø–æ—á–∞—Ç–∏ —Ç—Ä–∞–Ω—Å–ª—è—Ü—ñ—é</p>
        
        <button class="button" id="startBtn" onclick="startStreaming()">
            üé¨ –ü–æ—á–∞—Ç–∏ —Ç—Ä–∞–Ω—Å–ª—è—Ü—ñ—é
        </button>
        
        <button class="button stop hidden" id="stopBtn" onclick="stopStreaming()">
            ‚èπÔ∏è –ó—É–ø–∏–Ω–∏—Ç–∏ —Ç—Ä–∞–Ω—Å–ª—è—Ü—ñ—é
        </button>
        
        <div id="status"></div>
        
        <div id="streamInfo" class="stream-info hidden">
            <h3>–¢—Ä–∞–Ω—Å–ª—è—Ü—ñ—è –∞–∫—Ç–∏–≤–Ω–∞!</h3>
            <button class="button" onclick="openViewer()">
                üîó –í—ñ–¥–∫—Ä–∏—Ç–∏ —Å—Ç–æ—Ä—ñ–Ω–∫—É –ø–µ—Ä–µ–≥–ª—è–¥—É
            </button>
        </div>
    </div>

    <script>
        let mediaStream = null;
        let peerConnection = null;
        let dataChannel = null;

        async function startStreaming() {
            try {
                showStatus('–ó–∞–ø–∏—Ç –¥–æ—Å—Ç—É–ø—É –¥–æ –µ–∫—Ä–∞–Ω—É...', 'info');
                
                // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ API
                if (!navigator.mediaDevices || !navigator.mediaDevices.getDisplayMedia) {
                    showStatus('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î –∑–∞—Ö–æ–ø–ª–µ–Ω–Ω—è –µ–∫—Ä–∞–Ω—É. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ Chrome, Edge –∞–±–æ Firefox', 'error');
                    return;
                }

                mediaStream = await navigator.mediaDevices.getDisplayMedia({
                    video: {
                        cursor: "always",
                        displaySurface: "monitor"
                    },
                    audio: false
                });

                // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Å—Ç—Ä—ñ–º –≥–ª–æ–±–∞–ª—å–Ω–æ –¥–ª—è –¥–æ—Å—Ç—É–ø—É –∑ —ñ–Ω—à–æ–≥–æ –≤—ñ–∫–Ω–∞
                window.activeMediaStream = mediaStream;
                localStorage.setItem('streamActive', 'true');
                
                showStatus('–¢—Ä–∞–Ω—Å–ª—è—Ü—ñ—è —Ä–æ–∑–ø–æ—á–∞—Ç–∞!', 'success');
                document.getElementById('startBtn').classList.add('hidden');
                document.getElementById('stopBtn').classList.remove('hidden');
                document.getElementById('streamInfo').classList.remove('hidden');

                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ –≤—ñ–∫–Ω–æ –ø–µ—Ä–µ–≥–ª—è–¥—É
                openViewer();

                mediaStream.getVideoTracks()[0].onended = () => {
                    stopStreaming();
                };

            } catch (error) {
                console.error('–ü–æ–º–∏–ª–∫–∞:', error);
                if (error.name === 'NotAllowedError') {
                    showStatus('–î–æ—Å—Ç—É–ø –¥–æ –µ–∫—Ä–∞–Ω—É –≤—ñ–¥—Ö–∏–ª–µ–Ω–æ', 'error');
                } else {
                    showStatus('–ü–æ–º–∏–ª–∫–∞: ' + error.message, 'error');
                }
            }
        }

        function openViewer() {
            const viewerUrl = window.location.href.split('?')[0] + '?view=true';
            window.open(viewerUrl, 'StreamViewer', 'width=1280,height=720');
        }

        function stopStreaming() {
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
                window.activeMediaStream = null;
            }
            
            localStorage.removeItem('streamActive');

            showStatus('–¢—Ä–∞–Ω—Å–ª—è—Ü—ñ—è –∑—É–ø–∏–Ω–µ–Ω–∞', 'info');
            document.getElementById('startBtn').classList.remove('hidden');
            document.getElementById('stopBtn').classList.add('hidden');
            document.getElementById('streamInfo').classList.add('hidden');
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = 'status ' + type;
        }

        // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ä–µ–∂–∏–º—É –ø–µ—Ä–µ–≥–ª—è–¥—É
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('view') === 'true') {
            document.body.innerHTML = `
                <div class="viewer-page">
                    <video id="streamVideo" autoplay playsinline muted></video>
                    <div class="viewer-info">
                        <p style="font-size: 1.5em;">üî¥ –¢—Ä–∞–Ω—Å–ª—è—Ü—ñ—è –≤ –ø—Ä—è–º–æ–º—É –µ—Ñ—ñ—Ä—ñ</p>
                        <p id="viewerStatus">–ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è...</p>
                    </div>
                </div>
            `;

            const video = document.getElementById('streamVideo');
            const statusEl = document.getElementById('viewerStatus');

            function connectToStream() {
                if (window.opener && window.opener.activeMediaStream) {
                    video.srcObject = window.opener.activeMediaStream;
                    statusEl.textContent = '–ü—ñ–¥–∫–ª—é—á–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ!';
                    statusEl.style.color = '#4ade80';
                } else {
                    statusEl.textContent = '–û—á—ñ–∫—É–≤–∞–Ω–Ω—è —Å—Ç—Ä—ñ–º—É...';
                    setTimeout(connectToStream, 500);
                }
            }

            connectToStream();

            // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ —Å—Ç—Ä—ñ–º—É
            setInterval(() => {
                if (!localStorage.getItem('streamActive')) {
                    statusEl.textContent = '–¢—Ä–∞–Ω—Å–ª—è—Ü—ñ—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞';
                    statusEl.style.color = '#ff6b6b';
                }
            }, 1000);
        }

        window.addEventListener('beforeunload', () => {
            if (mediaStream) {
                stopStreaming();
            }
        });
    </script>
</body>
</html>
